name: CI

on:
  push:
    branches: [main, develop, 'claude/**']
  pull_request:
    branches: [main, develop]

jobs:
  backend-ci:
    name: Backend CI
    uses: ./.github/workflows/backend-ci.yml
    if: |
      contains(github.event.head_commit.modified, 'backend/') ||
      contains(github.event.head_commit.added, 'backend/') ||
      github.event_name == 'pull_request'

  frontend-ci:
    name: Frontend CI
    uses: ./.github/workflows/frontend-ci.yml
    if: |
      contains(github.event.head_commit.modified, 'frontend/') ||
      contains(github.event.head_commit.added, 'frontend/') ||
      github.event_name == 'pull_request'

  all-checks:
    name: All Checks Passed
    runs-on: ubuntu-latest
    needs: [backend-ci, frontend-ci]
    if: always()

    steps:
      - name: Check if all jobs passed
        run: |
          if [[ "${{ needs.backend-ci.result }}" == "success" && "${{ needs.frontend-ci.result }}" == "success" ]]; then
            echo "✅ All CI checks passed!"
            exit 0
          elif [[ "${{ needs.backend-ci.result }}" == "skipped" && "${{ needs.frontend-ci.result }}" == "success" ]]; then
            echo "✅ Frontend CI checks passed (Backend skipped)!"
            exit 0
          elif [[ "${{ needs.backend-ci.result }}" == "success" && "${{ needs.frontend-ci.result }}" == "skipped" ]]; then
            echo "✅ Backend CI checks passed (Frontend skipped)!"
            exit 0
          elif [[ "${{ needs.backend-ci.result }}" == "skipped" && "${{ needs.frontend-ci.result }}" == "skipped" ]]; then
            echo "✅ No CI checks needed (both skipped - no backend/frontend changes)!"
            exit 0
          else
            echo "❌ Some CI checks failed"
            echo "Backend: ${{ needs.backend-ci.result }}"
            echo "Frontend: ${{ needs.frontend-ci.result }}"
            exit 1
          fi
